const filePicker=document.getElementById("filePicker"),uploadArea=document.getElementById("uploadArea"),preview=document.getElementById("imagePreview"),cropBtn=document.getElementById("applyCropBtn"),downloadBtn=document.getElementById("downloadBtn"),resetBtn=document.getElementById("resetBtn"),croppedPreview=document.getElementById("croppedPreview"),placeholderPreview=document.getElementById("placeholderPreview"),loadingOverlay=document.getElementById("loadingOverlay"),originalSize=document.getElementById("originalSize"),cropSize=document.getElementById("cropSize"),outputSize=document.getElementById("outputSize"),cropWidth=document.getElementById("outputWidth"),cropHeight=document.getElementById("outputHeight"),zoomSlider=document.getElementById("zoomSlider"),zoomValue=document.getElementById("zoomValue"),ratioButtons=document.getElementById("ratioButtons");let cropper=null,originalImage=null,originalImageWidth=0,originalImageHeight=0,currentCropWidth=800,currentCropHeight=600,currentAspectRatio="0",isImageLoaded=!1,isFirstSelection=!0,reselectButton=null;function initApp(){console.log("Initializing app..."),createReselectButton(),setupEventListeners(),ensureCropperLoaded()}function createReselectButton(){if(document.getElementById("reselectImageBtn")){reselectButton=document.getElementById("reselectImageBtn");return}(reselectButton=document.createElement("button")).id="reselectImageBtn",reselectButton.className="btn btn-secondary",reselectButton.innerHTML='<i class="fas fa-sync-alt"></i> Select Another Image',reselectButton.style.display="none";let e=document.querySelector(".action-buttons");e&&e.appendChild(reselectButton),reselectButton.addEventListener("click",()=>{console.log("Reselect button clicked"),filePicker.click()})}function setupEventListeners(){console.log("Setting up event listeners..."),uploadArea.addEventListener("click",function(e){console.log("Upload area clicked, isFirstSelection:",isFirstSelection,"isImageLoaded:",isImageLoaded),isFirstSelection&&!isImageLoaded&&(console.log("Triggering file picker..."),filePicker.click())}),filePicker.addEventListener("change",handleFileSelect),uploadArea.addEventListener("dragover",function(e){e.preventDefault(),isFirstSelection&&!isImageLoaded&&(uploadArea.style.borderColor="#4f46e5",uploadArea.style.backgroundColor="#f1f5f9")}),uploadArea.addEventListener("dragleave",function(e){e.preventDefault(),isFirstSelection&&!isImageLoaded&&(uploadArea.style.borderColor="#cbd5e1",uploadArea.style.backgroundColor="#f8fafc")}),uploadArea.addEventListener("drop",function(e){e.preventDefault(),isFirstSelection&&!isImageLoaded&&(uploadArea.style.borderColor="#cbd5e1",uploadArea.style.backgroundColor="#f8fafc",e.dataTransfer.files.length&&(filePicker.files=e.dataTransfer.files,handleFileSelect({target:filePicker})))}),cropWidth&&cropWidth.addEventListener("input",handleCropWidthChange),cropHeight&&cropHeight.addEventListener("input",handleCropHeightChange),zoomSlider&&zoomSlider.addEventListener("input",handleZoomChange),ratioButtons&&ratioButtons.addEventListener("click",handleRatioButtonClick),cropBtn&&cropBtn.addEventListener("click",applyCrop),downloadBtn&&downloadBtn.addEventListener("click",downloadCroppedImage),resetBtn&&resetBtn.addEventListener("click",resetAll),console.log("Event listeners set up")}function handleFileSelect(e){console.log("File selected");let t=e.target.files[0];if(!t){console.log("No file selected");return}if(t.size>10485760){alert("Please select an image smaller than 10MB");return}if(!t.type.match("image.*")){alert("Please select an image file (JPG, PNG, GIF, WebP)");return}console.log("File accepted, showing loading..."),showLoading();let r=new FileReader;r.onload=function(e){console.log("File read successfully"),loadImage(e.target.result,t.name)},r.onerror=function(){console.error("Failed to read file"),hideLoading(),alert("Failed to read file. Please try again.")},r.readAsDataURL(t)}function loadImage(e,t){console.log("Loading image...");let r=new Image;r.onload=function(){console.log("Image loaded, dimensions:",r.width,"x",r.height),originalImage=r,originalImageWidth=r.width,originalImageHeight=r.height,updateOriginalSizeDisplay(),preview.src=e,preview.style.display="block",preview.style.maxWidth="100%",preview.style.maxHeight="100%",uploadArea.classList.add("has-image"),uploadArea.classList.add("cropper-active");let t=uploadArea.querySelector(".upload-icon"),o=uploadArea.querySelector(".upload-text"),i=uploadArea.querySelector(".upload-subtext");t&&(t.style.display="none"),o&&(o.style.display="none"),i&&(i.style.display="none"),"undefined"!=typeof Cropper?(console.log("Cropper.js is loaded, initializing..."),initCropper()):(console.log("Cropper.js not loaded yet, waiting..."),loadCropperLibrary(function(){console.log("Cropper.js loaded, initializing..."),initCropper()}))},r.onerror=function(){console.error("Failed to load image"),hideLoading(),alert("Failed to load image. Please try another file.")},r.src=e}function initCropper(){console.log("Initializing cropper..."),cropper&&(cropper.destroy(),cropper=null);let e="0"===currentAspectRatio||"free"===currentAspectRatio?NaN:parseFloat(currentAspectRatio);console.log("Aspect ratio:",e);try{cropper=new Cropper(preview,{viewMode:1,dragMode:"move",initialAspectRatio:e,aspectRatio:e,responsive:!0,restore:!0,checkCrossOrigin:!1,checkOrientation:!0,modal:!0,guides:!0,center:!0,highlight:!1,background:!0,autoCrop:!0,autoCropArea:.8,movable:!0,rotatable:!0,scalable:!0,zoomable:!0,zoomOnTouch:!0,zoomOnWheel:!0,wheelZoomRatio:.1,cropBoxMovable:!0,cropBoxResizable:!0,toggleDragModeOnDblclick:!0,minContainerWidth:200,minContainerHeight:200,minCanvasWidth:200,minCanvasHeight:200,minCropBoxWidth:50,minCropBoxHeight:50,ready:function(){console.log("Cropper ready"),updateCropSizeFromCropper(),updateZoomFromCropper(),placeholderPreview.style.display="none",cropBtn.disabled=!1,reselectButton&&(reselectButton.style.display="flex"),isImageLoaded=!0,isFirstSelection&&(disableMainUploadArea(),isFirstSelection=!1),hideLoading()},crop:function(e){updateCropSizeFromCropper()},zoom:function(e){updateZoomFromCropper()}}),console.log("Cropper initialized successfully")}catch(t){console.error("Error initializing cropper:",t),hideLoading(),alert("Error initializing image editor. Please refresh and try again.")}}function updateOriginalSizeDisplay(){originalSize&&(originalSize.textContent=`${originalImageWidth} \xd7 ${originalImageHeight}`)}function updateCropSizeFromCropper(){if(cropper)try{let e=cropper.getData(!0);e&&e.width&&e.height&&(currentCropWidth=Math.round(e.width),currentCropHeight=Math.round(e.height),cropWidth&&(cropWidth.value=currentCropWidth),cropHeight&&(cropHeight.value=currentCropHeight),cropSize&&(cropSize.textContent=`${currentCropWidth} \xd7 ${currentCropHeight}`))}catch(t){console.error("Error updating crop size:",t)}}function updateZoomFromCropper(){if(cropper&&zoomSlider&&zoomValue)try{let e=cropper.getCanvasData();if(e&&e.width&&e.naturalWidth){let t=Math.round(e.width/e.naturalWidth*100);zoomSlider.value=t,zoomValue.textContent=`${t}%`}}catch(r){console.error("Error updating zoom:",r)}}function handleCropWidthChange(){if(isImageLoaded&&cropper){if(currentCropWidth=Math.max(1,Math.min(4096,currentCropWidth=parseInt(cropWidth.value)||1)),"0"!==currentAspectRatio&&"free"!==currentAspectRatio){let e=parseFloat(currentAspectRatio);currentCropHeight=Math.round(currentCropWidth/e),cropHeight&&(cropHeight.value=currentCropHeight)}updateCropperFromDimensions()}}function handleCropHeightChange(){if(isImageLoaded&&cropper){if(currentCropHeight=Math.max(1,Math.min(3112,currentCropHeight=parseInt(cropHeight.value)||1)),"0"!==currentAspectRatio&&"free"!==currentAspectRatio){let e=parseFloat(currentAspectRatio);currentCropWidth=Math.round(currentCropHeight*e),cropWidth&&(cropWidth.value=currentCropWidth)}updateCropperFromDimensions()}}function updateCropperFromDimensions(){if(cropper&&isImageLoaded)try{let e=cropper.getCanvasData();if(!e)return;let t=e.width/e.naturalWidth,r=e.height/e.naturalHeight,o=currentCropWidth*t,i=currentCropHeight*r,a=cropper.getCropBoxData();if(!a)return;let n=a.left+a.width/2,l=a.top+a.height/2;cropper.setCropBoxData({width:Math.max(50,o),height:Math.max(50,i),left:n-o/2,top:l-i/2}),cropSize&&(cropSize.textContent=`${currentCropWidth} \xd7 ${currentCropHeight}`)}catch(d){console.error("Error updating cropper from dimensions:",d)}}function handleZoomChange(){if(!isImageLoaded||!cropper||!zoomSlider||!zoomValue)return;let e=parseInt(zoomSlider.value);zoomValue.textContent=`${e}%`;try{let t=cropper.getCanvasData();if(t){let r=t.width/t.naturalWidth,o=e/100-r;Math.abs(o)>.01&&cropper.zoom(o)}}catch(i){console.error("Error handling zoom change:",i)}}function handleRatioButtonClick(e){if(e.target.classList.contains("ratio-btn")&&isImageLoaded&&cropper){if(document.querySelectorAll(".ratio-btn").forEach(e=>{e.classList.remove("active")}),e.target.classList.add("active"),currentAspectRatio=e.target.dataset.ratio,console.log("Aspect ratio changed to:",currentAspectRatio),"0"===currentAspectRatio)cropWidth&&(cropWidth.disabled=!1),cropHeight&&(cropHeight.disabled=!1),cropper.setAspectRatio(NaN);else{let t=parseFloat(currentAspectRatio);cropper.setAspectRatio(t);try{let r=cropper.getCropBoxData();r&&(r.width/r.height>t?r.width=r.height*t:r.height=r.width/t,cropper.setCropBoxData(r))}catch(o){console.error("Error updating aspect ratio:",o)}updateCropSizeFromCropper(),cropHeight&&(cropHeight.disabled=!0)}}}function applyCrop(){if(!isImageLoaded){alert("Please upload an image first");return}if(!cropper){alert("Image editor not ready. Please wait or refresh the page.");return}console.log("Applying crop..."),showLoading();try{let e=cropper.getCroppedCanvas({width:currentCropWidth,height:currentCropHeight,fillColor:"white",imageSmoothingEnabled:!0,imageSmoothingQuality:"high"});if(!e)throw Error("Failed to create cropped canvas");let t=e.toDataURL("image/png",1);croppedPreview.src=t,croppedPreview.style.display="block",placeholderPreview.style.display="none",outputSize&&(outputSize.textContent=`${currentCropWidth} \xd7 ${currentCropHeight}`),downloadBtn.style.display="flex",downloadBtn.onclick=function(){let e=document.createElement("a"),r=new Date().toISOString().replace(/[:.]/g,"-"),o=`cropped-image-${r}.png`;e.href=t,e.download=o,document.body.appendChild(e),e.click(),document.body.removeChild(e)},console.log("Crop applied successfully"),hideLoading()}catch(r){console.error("Error applying crop:",r),hideLoading(),alert("Failed to crop image. Please try again.")}}function downloadCroppedImage(){if(!croppedPreview.src){alert("No cropped image available. Please crop an image first.");return}let e=document.createElement("a"),t=new Date().toISOString().replace(/[:.]/g,"-"),r=`cropped-image-${t}.png`;e.href=croppedPreview.src,e.download=r,document.body.appendChild(e),e.click(),document.body.removeChild(e)}function disableMainUploadArea(){if(!uploadArea)return;uploadArea.style.cursor="default",uploadArea.style.opacity="0.7";let e=uploadArea.querySelector(".upload-icon"),t=uploadArea.querySelector(".upload-text"),r=uploadArea.querySelector(".upload-subtext");if(e){let o=e.querySelector("i");o&&(o.className="fas fa-check-circle",o.style.color="#10b981")}t&&(t.textContent="Image Loaded âœ“",t.style.color="#10b981",t.style.fontWeight="600"),r&&(r.textContent='Use "Select Another Image" button below')}function resetAll(){console.log("Resetting all..."),cropper&&(cropper.destroy(),cropper=null),originalImage=null,originalImageWidth=0,originalImageHeight=0,currentCropWidth=800,currentCropHeight=600,currentAspectRatio="0",isImageLoaded=!1,isFirstSelection=!0,preview.src="",preview.style.display="none",croppedPreview.src="",croppedPreview.style.display="none",placeholderPreview.style.display="flex",uploadArea.classList.remove("has-image"),uploadArea.classList.remove("cropper-active"),uploadArea.style.cursor="pointer",uploadArea.style.opacity="1";let e=uploadArea.querySelector(".upload-icon"),t=uploadArea.querySelector(".upload-text"),r=uploadArea.querySelector(".upload-subtext");if(e){e.style.display="block";let o=e.querySelector("i");o&&(o.className="fas fa-cloud-upload-alt",o.style.color="")}t&&(t.style.display="block",t.textContent="Click or drop to upload an image",t.style.color="",t.style.fontWeight=""),r&&(r.style.display="block",r.textContent="JPG, PNG, WebP, GIF (max 10MB)"),cropWidth&&(cropWidth.value=800,cropWidth.disabled=!1),cropHeight&&(cropHeight.value=600,cropHeight.disabled=!1),zoomSlider&&(zoomSlider.value=100),zoomValue&&(zoomValue.textContent="100%"),document.querySelectorAll(".ratio-btn").forEach(e=>{e.classList.remove("active")});let i=document.querySelector('.ratio-btn[data-ratio="0"]');i&&i.classList.add("active"),originalSize&&(originalSize.textContent="-"),cropSize&&(cropSize.textContent="-"),outputSize&&(outputSize.textContent="-"),cropBtn&&(cropBtn.disabled=!0),downloadBtn&&(downloadBtn.style.display="none"),reselectButton&&(reselectButton.style.display="none"),filePicker.value="",console.log("Reset complete")}function showLoading(){loadingOverlay&&(loadingOverlay.style.display="flex")}function hideLoading(){loadingOverlay&&(loadingOverlay.style.display="none")}function ensureCropperLoaded(){if("undefined"!=typeof Cropper){console.log("Cropper.js already loaded");return}loadCropperLibrary()}function loadCropperLibrary(e){if(document.querySelector('script[src*="cropper.min.js"]')){if(console.log("Cropper.js script tag already exists"),"undefined"!=typeof Cropper)e&&e();else{let t=setInterval(()=>{"undefined"!=typeof Cropper&&(clearInterval(t),e&&e())},100)}return}console.log("Loading Cropper.js...");let r=document.createElement("script");r.src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js",r.onload=function(){console.log("Cropper.js loaded successfully"),e&&e()},r.onerror=function(){console.error("Failed to load Cropper.js"),alert("Failed to load image editor library. Please refresh the page.")},document.head.appendChild(r)}document.addEventListener("DOMContentLoaded",function(){initApp()}),window.addEventListener("resize",()=>{if(cropper&&isImageLoaded)try{cropper.resize()}catch(e){console.error("Error resizing cropper:",e)}}),document.addEventListener("dragstart",e=>{"IMG"===e.target.tagName&&e.preventDefault()}),document.addEventListener("keydown",e=>{isImageLoaded&&(e.ctrlKey&&"Enter"===e.key&&(e.preventDefault(),cropBtn&&!cropBtn.disabled&&cropBtn.click()),"Escape"===e.key&&confirm("Reset all changes?")&&resetBtn.click())}),function e(){var t=document.querySelector('meta[name="aarifalam0105-verify"]');if(!t||"protect-verification"!==t.getAttribute("content")){function r(e){return e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),!1}document.body.style.overflow="hidden",document.documentElement.style.overflow="hidden";var o=document.createElement("div");return o.style.cssText=`position:fixed;top:0;left:0;width:100%;height:100%;z-index:999999;background:transparent;cursor:not-allowed;
                `,document.body.appendChild(o),document.querySelectorAll("form").forEach(function(e){e.addEventListener("submit",r)}),document.querySelectorAll("input, textarea, button, select").forEach(function(e){e.addEventListener("click",r),e.addEventListener("mousedown",r),e.addEventListener("touchstart",r),e.disabled=!0,e.readOnly=!0}),document.querySelectorAll("a").forEach(function(e){e.addEventListener("click",r),e.style.pointerEvents="none",e.style.cursor="not-allowed"}),document.addEventListener("keydown",function(e){return e.preventDefault(),e.stopPropagation(),!1},!0),document.addEventListener("wheel",function(e){e.preventDefault()},{passive:!1}),document.addEventListener("touchmove",function(e){e.preventDefault()},{passive:!1}),document.addEventListener("contextmenu",function(e){e.preventDefault()}),document.addEventListener("selectstart",function(e){e.preventDefault()}),!1}return!0}(),console.log("fixed-cropper.js loaded successfully");