document.addEventListener("DOMContentLoaded",function(){"use strict";let e={workerUrl:"https://instagram-downloader.aarif753alam.workers.dev",allowedDomains:["aarifalam.life","aarifalam.pages.dev"],maxUrlLength:500,instagramPatterns:[/https?:\/\/(?:www\.)?instagram\.com\/(?:p|reel|tv|stories)\/([A-Za-z0-9_-]+)/i,/https?:\/\/(?:www\.)?instagram\.com\/stories\/[^\/]+\/(\d+)/i,/https?:\/\/instagr\.am\/(?:p|reel|tv|stories)\/([A-Za-z0-9_-]+)/i]},t={isProcessing:!1,currentVideoData:null,apiEndpoint:e.workerUrl,currentUrl:"",errorRetryCount:0},n={urlInput:document.getElementById("urlInput"),downloadBtn:document.getElementById("downloadBtn"),pasteBtn:document.getElementById("pasteBtn"),resultContainer:document.getElementById("resultContainer"),errorContainer:document.getElementById("errorContainer"),closeResult:document.getElementById("closeResult"),closeError:document.getElementById("closeError"),retryBtn:document.getElementById("retryBtn"),videoPreview:document.getElementById("videoPreview"),qualityLabel:document.getElementById("qualityLabel"),durationLabel:document.getElementById("durationLabel"),sizeLabel:document.getElementById("sizeLabel"),downloadVideoBtn:document.getElementById("downloadVideoBtn"),copyLinkBtn:document.getElementById("copyLinkBtn"),errorMessage:document.getElementById("errorMessage"),notification:document.getElementById("notification"),supportedFormats:document.querySelector(".supported-formats"),actionButtons:document.querySelector(".action-buttons")};function r(t){if(!t||t.length>e.maxUrlLength)return!1;try{let n=new URL(t);if(!["http:","https:"].includes(n.protocol))return!1;return e.instagramPatterns.some(e=>e.test(t))}catch{return!1}}async function i(){try{let e=await navigator.clipboard.readText();e&&(n.urlInput.value=e,n.urlInput.dispatchEvent(new Event("input")),f("\uD83D\uDCCB URL pasted from clipboard",1500),n.urlInput.focus(),setTimeout(()=>{r(e)&&o()},300))}catch(t){console.error("Failed to read clipboard:",t),navigator.userAgent.match(/ipad|iphone/i)?u("⚠️ Please long-press and paste in the input field"):u("❌ Unable to access clipboard. Please paste manually.")}}async function o(){let e=n.urlInput.value.trim();if(t.currentUrl=e,!r(e)){u("❌ Please enter a valid Instagram URL\n\nExamples:\n• https://instagram.com/p/ABC123\n• https://instagram.com/reel/XYZ456\n• https://instagram.com/stories/user/789"),n.urlInput.focus();return}if(!t.isProcessing){t.isProcessing=!0,t.errorRetryCount=0,a(!0),y(n.errorContainer);try{f("⏳ Fetching video data from Instagram...",2e3);let i=await l(e);if(i.success)(function e(r){t.currentVideoData=r;let i=r.dimensions||{},o=i.height&&i.width?`${i.height}p (${i.width}\xd7${i.height})`:r.quality||"HD",a=r.duration?function e(t){if(!t||t<=0)return"Unknown";let n=Math.floor(t/3600),r=Math.floor(t%3600/60),i=Math.floor(t%60);return n>0?`${n}:${r.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`:`${r}:${i.toString().padStart(2,"0")}`}(r.duration):"Loading...",l=r.size?function e(t){if(!t||t<=0)return"Unknown";let n=["B","KB","MB","GB"],r=t,i=0;for(;r>=1024&&i<n.length-1;)r/=1024,i++;return`${r.toFixed(0===i?0:1)} ${n[i]}`}(r.size):"Calculating...";n.qualityLabel.textContent=o,n.durationLabel.textContent=a,n.sizeLabel.textContent=l,n.qualityLabel.style.color="#10b981",n.durationLabel.style.color="#10b981",n.sizeLabel.style.color="#10b981",function e(t){n.videoPreview.innerHTML="";let r=document.createElement("video");r.src=t.videoUrl,r.controls=!0,r.preload="metadata",r.style.width="100%",r.style.height="100%",r.style.objectFit="contain",r.style.borderRadius="var(--radius-lg)",r.style.backgroundColor="#000",r.setAttribute("title","Instagram Video Preview"),r.setAttribute("playsinline",""),r.addEventListener("waiting",()=>{n.videoPreview.innerHTML=`
                <div class="preview-placeholder" style="text-align: center; padding: 2rem;">
                    <div class="loading-spinner" style="width: 40px; height: 40px; border: 3px solid #f3f3f3; border-top: 3px solid #6366f1; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
                    <p style="color: #64748b; font-weight: 500;">Loading preview...</p>
                </div>
            `}),r.addEventListener("canplay",()=>{n.videoPreview.innerHTML="",n.videoPreview.appendChild(r)}),r.addEventListener("error",()=>{if(t.thumbnail){let e=document.createElement("img");e.src=t.thumbnail,e.alt="Video thumbnail",e.style.width="100%",e.style.height="100%",e.style.objectFit="cover",e.style.borderRadius="var(--radius-lg)",n.videoPreview.appendChild(e)}else n.videoPreview.innerHTML=`
                    <div class="preview-placeholder">
                        <i class="fas fa-film" style="font-size: 3rem; color: #94a3b8;"></i>
                        <p style="margin-top: 1rem; color: #64748b;">Preview not available</p>
                    </div>
                `}),r.load()}(r);let s=$(r);n.downloadVideoBtn.setAttribute("download",s),n.downloadVideoBtn.setAttribute("title",`Download: ${s}`),p(n.resultContainer),window.innerWidth<768&&n.resultContainer.scrollIntoView({behavior:"smooth",block:"nearest"}),setTimeout(()=>{n.downloadVideoBtn.focus()},300)})(i),f("✅ Video ready for download!",3e3);else throw Error(i.error||"Failed to extract video")}catch(s){console.error("Download error:",s),s.message.includes("network")||s.message.includes("fetch")?u("\uD83C\uDF10 Network error. Please check your internet connection and try again."):s.message.includes("private")||s.message.includes("login")?u("\uD83D\uDD12 This video is private or requires login. Only public videos can be downloaded."):s.message.includes("not found")||s.message.includes("404")?u("\uD83D\uDD0D Video not found. The link might be broken or the video was removed."):s.message.includes("rate limit")||s.message.includes("too many")?u("⏰ Rate limited. Please wait a few minutes before trying again."):u(`❌ ${s.message||"Failed to fetch video. Please try again."}`),t.errorRetryCount++,t.errorRetryCount<2&&navigator.onLine&&setTimeout(()=>{r(t.currentUrl)&&o()},2e3)}finally{t.isProcessing=!1,a(!1)}}}function a(e){if(e)n.downloadBtn.classList.add("loading"),n.downloadBtn.disabled=!0,n.urlInput.disabled=!0,n.pasteBtn.disabled=!0,n.downloadBtn.setAttribute("aria-busy","true"),n.downloadBtn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Processing...';else{n.downloadBtn.classList.remove("loading"),n.urlInput.disabled=!1,n.pasteBtn.disabled=!1,n.downloadBtn.setAttribute("aria-busy","false");let t=r(n.urlInput.value.trim());n.downloadBtn.disabled=!t,n.downloadBtn.innerHTML='<i class="fas fa-download"></i> Get Video'}}async function l(e){let n=new AbortController,r=setTimeout(()=>n.abort(),3e4);try{let i=await fetch(t.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",Origin:window.location.origin},body:JSON.stringify({url:e,timestamp:new Date().toISOString(),userAgent:navigator.userAgent.slice(0,100)}),signal:n.signal,mode:"cors",credentials:"omit"});if(clearTimeout(r),!i.ok){let o=await i.text(),a=`Server error: ${i.status}`;try{let l=JSON.parse(o);a=l.error||a}catch{a=o||a}throw Error(a)}let s=await i.json();return s}catch(d){if(clearTimeout(r),"AbortError"===d.name)throw Error("Request timeout. The server is taking too long to respond.");throw d}}async function s(){if(t.currentVideoData)try{let r=n.downloadVideoBtn.innerHTML;n.downloadVideoBtn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Preparing...',n.downloadVideoBtn.disabled=!0,n.copyLinkBtn.disabled=!0,f("⏳ Starting download...",2e3);let i=document.createElement("iframe");i.style.display="none",i.src=t.currentVideoData.videoUrl,document.body.appendChild(i);let o=document.createElement("a");o.href=t.currentVideoData.videoUrl,o.download=$(t.currentVideoData),o.style.display="none",document.body.appendChild(o),o.click(),document.body.removeChild(o),function t(n){let r={timestamp:new Date().toISOString(),quality:n.quality,dimensions:n.dimensions,duration:n.duration,size:n.size,source:window.location.hostname,userAgent:navigator.userAgent.slice(0,100)};if(console.log("\uD83D\uDCCA Download tracked:",r),navigator.sendBeacon)try{navigator.sendBeacon(`${e.workerUrl}/track`,JSON.stringify(r))}catch(i){console.log("Beacon sending failed:",i)}}(t.currentVideoData),f("✅ Download started! Check your downloads folder.",3e3),setTimeout(()=>{n.downloadVideoBtn.innerHTML=r,n.downloadVideoBtn.disabled=!1,n.copyLinkBtn.disabled=!1},1500)}catch(a){console.error("Download failed:",a);try{await navigator.clipboard.writeText(t.currentVideoData.videoUrl),f("\uD83D\uDCCB Video link copied! Paste in browser to download.",4e3)}catch{u('❌ Could not start download. Please try:\n1. Right-click the "Copy Link" button\n2. Select "Save link as..."\n3. Save the video file')}n.downloadVideoBtn.innerHTML='<i class="fas fa-download"></i> Download Video',n.downloadVideoBtn.disabled=!1,n.copyLinkBtn.disabled=!1}}async function d(){if(t.currentVideoData)try{await navigator.clipboard.writeText(t.currentVideoData.videoUrl);let e=n.copyLinkBtn.innerHTML;n.copyLinkBtn.innerHTML='<i class="fas fa-check"></i> Copied!',n.copyLinkBtn.style.background="#10b981",n.copyLinkBtn.style.color="white",n.copyLinkBtn.style.borderColor="#10b981",f("\uD83D\uDCCB Video link copied to clipboard!",2e3),setTimeout(()=>{n.copyLinkBtn.innerHTML=e,n.copyLinkBtn.style.background="",n.copyLinkBtn.style.color="",n.copyLinkBtn.style.borderColor=""},2e3)}catch(r){console.error("Failed to copy:",r);let i=document.createElement("textarea");i.value=t.currentVideoData.videoUrl,document.body.appendChild(i),i.select();try{document.execCommand("copy"),f("\uD83D\uDCCB Link copied (fallback method)",2e3)}catch{u("❌ Failed to copy link. Please copy manually from below:"),n.errorMessage.innerHTML=`
                    Copy this link manually:<br>
                    <code style="background: #f1f5f9; padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem; display: inline-block; max-width: 100%; overflow-x: auto;">
                        ${t.currentVideoData.videoUrl.slice(0,100)}...
                    </code>
                `,p(n.errorContainer)}document.body.removeChild(i)}}function c(){y(n.errorContainer),n.urlInput.focus(),n.urlInput.select(),t.currentUrl&&r(t.currentUrl)&&setTimeout(()=>{o()},500)}function u(e){n.errorMessage.textContent=e,n.errorMessage.style.whiteSpace="pre-line",p(n.errorContainer),t.currentUrl&&r(t.currentUrl)?n.retryBtn.style.display="inline-flex":n.retryBtn.style.display="none",setTimeout(()=>{"none"!==n.retryBtn.style.display?n.retryBtn.focus():n.urlInput.focus()},100),setTimeout(()=>{n.errorContainer.classList.contains("hidden")||y(n.errorContainer)},1e4)}function p(e){e.classList.remove("hidden"),e.style.display="block",e.setAttribute("aria-hidden","false"),e.style.animation="fadeInUp 0.3s ease-out"}function y(e){e.classList.add("hidden"),e.setAttribute("aria-hidden","true")}function f(e,t=3e3){e.includes("✨")||e.includes("✅")||e.includes("⚠️")||e.includes("❌")||e.includes("⏳")||e.includes("\uD83D\uDCCB")||(e="\uD83D\uDCA1 "+e),n.notification.innerHTML=`
            <i class="fas fa-info-circle" style="color: #6366f1; font-size: 1.2rem;"></i>
            <span>${e}</span>
        `,n.notification.classList.add("show"),n.notification.style.animation="fadeInUp 0.3s ease-out";let r=setTimeout(()=>{n.notification.classList.remove("show")},t);n.notification.addEventListener("mouseenter",()=>{clearTimeout(r)}),n.notification.addEventListener("mouseleave",()=>{setTimeout(()=>{n.notification.classList.remove("show")},1e3)})}function $(e){let t=new Date,n=t.toISOString().slice(0,10).replace(/-/g,""),r=t.toTimeString().slice(0,8).replace(/:/g,""),i="HD";return e.dimensions&&e.dimensions.height?i=`${e.dimensions.height}p`:e.quality&&(i=e.quality.replace(/\s+/g,"-")),`instagram_${n}_${r}_${i}.mp4`}let m=document.createElement("style");m.textContent=`
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .preview-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #64748b;
        }
        
        code {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
    `,document.head.appendChild(m),n.downloadBtn.addEventListener("click",o),n.pasteBtn.addEventListener("click",i),n.closeResult.addEventListener("click",()=>y(n.resultContainer)),n.closeError.addEventListener("click",()=>y(n.errorContainer)),n.retryBtn.addEventListener("click",c),n.downloadVideoBtn.addEventListener("click",s),n.copyLinkBtn.addEventListener("click",d),n.urlInput.addEventListener("keypress",function(e){"Enter"===e.key&&o()}),window.addEventListener("online",()=>{f("✅ You are back online",2e3)}),window.addEventListener("offline",()=>{u("⚠️ You are offline. Please check your internet connection.")}),document.addEventListener("click",function(e){n.resultContainer.classList.contains("hidden")||e.target.closest(".result-container")||e.target.closest("#downloadBtn")||y(n.resultContainer),n.errorContainer.classList.contains("hidden")||e.target.closest(".error-container")||e.target.closest("#downloadBtn")||y(n.errorContainer)}),function t(){let r=window.location.hostname,i=e.allowedDomains.some(e=>r===e||r.endsWith("."+e));return!!i||(n.urlInput.disabled=!0,n.downloadBtn.disabled=!0,u("This tool only works on aarifalam.life and aarifalam.pages.dev"),!1)}(),n.urlInput.addEventListener("input",function(){let e=this.value.trim(),o=r(e);e&&o?this.style.borderColor="#10b981":e&&!o?this.style.borderColor="#ef4444":this.style.borderColor="",n.downloadBtn.disabled=!o||t.isProcessing,function e(){let t=n.urlInput.value.trim().length>0;n.pasteBtn.innerHTML=t?'<i class="fas fa-redo"></i> Clear':'<i class="fas fa-paste"></i> Paste',t?n.pasteBtn.onclick=()=>{n.urlInput.value="",n.urlInput.dispatchEvent(new Event("input")),f("✏️ Input cleared",1e3),n.urlInput.focus()}:n.pasteBtn.onclick=i}()}),n.urlInput.addEventListener("focus",function(){this.style.transform="translateY(-1px)",this.style.boxShadow="0 0 0 3px rgba(99, 102, 241, 0.1)"}),n.urlInput.addEventListener("blur",function(){this.style.transform="",this.style.boxShadow=""}),document.addEventListener("keydown",function(e){"Escape"!==e.key||(n.resultContainer.classList.contains("hidden")||(y(n.resultContainer),n.urlInput.focus()),n.errorContainer.classList.contains("hidden")||(y(n.errorContainer),n.urlInput.focus())),e.ctrlKey&&"k"===e.key&&(e.preventDefault(),n.urlInput.focus(),n.urlInput.select()),e.ctrlKey&&"v"===e.key&&setTimeout(()=>{let e=n.urlInput.value.trim();r(e)&&o()},100)}),n.urlInput.setAttribute("aria-label","Instagram URL input field"),n.downloadBtn.setAttribute("aria-label","Get Instagram video"),n.downloadBtn.setAttribute("role","button"),n.pasteBtn.setAttribute("aria-label","Paste from clipboard"),n.urlInput.focus(),setTimeout(()=>{f("✨ Welcome to AarifAlam0105 Instagram Downloader!",4e3)},500)});