<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Time Analysis Tracker</title>
  <style>
      body {
          font-family: Arial, sans-serif;
          background-color: #f4f8fb;
          margin: 0;
          padding: 0;
          color: #333;
      }
      header {
          background-color: #4caf50;
          color: white;
          padding: 15px;
          text-align: center;
          position: relative;
      }
      .container {
          max-width: 900px;
          margin: auto;
          padding: 20px;
          background-color: white;
          border-radius: 8px;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      .calendar {
          display: grid;
          grid-template-columns: repeat(7, 1fr);
          gap: 10px;
          margin-bottom: 20px;
      }
      .day {
          background-color: #eaf1f8;
          border: 1px solid #ddd;
          border-radius: 4px;
          text-align: center;
          padding: 10px;
          cursor: pointer;
      }
      .day:hover { background-color: #d1e7f3; }
      .day.red { background-color: #f44336; color: white; }
      .day.cyan { background-color: #00bcd4; color: white; }
      .day.green { background-color: #4caf50; color: white; }
      .input-section { margin-top: 20px; }
      label { display: block; margin-bottom: 5px; font-weight: bold; }
      input, button, textarea {
          padding: 10px;
          font-size: 16px;
          width: 100%;
          margin-bottom: 15px;
          border: 1px solid #ddd;
          border-radius: 4px;
      }
      button {
          background-color: #4caf50;
          color: white;
          cursor: pointer;
      }
      button:hover { background-color: #45a049; }
      .nav-button { width: 100px; padding: 5px; font-size: 14px; }
      .results { margin-top: 30px; }
      .footer { text-align: center; margin-top: 30px; font-size: 14px; color: #777; }
      .admin-only { display: none; }
      .note-preview { 
          border: 1px solid #eee;
          padding: 10px;
          margin-top: 10px;
          min-height: 50px;
      }
  </style>
</head>
<body>
    <header>
        <h1>Time Analysis Tracker</h1>
        <button id="adminToggle" class="nav-button">Admin</button>
    </header>

    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <button class="nav-button" onclick="changeMonth(-1)">&lt; Previous</button>
            <h2 id="monthYear"></h2>
            <button class="nav-button" onclick="changeMonth(1)">Next &gt;</button>
        </div>
        
        <div class="calendar" id="calendar"></div>

        <!-- Admin Panel -->
        <div class="admin-only" id="adminPanel">
            <h3>Admin Panel</h3>
            <div id="selectedDateInfo">Select a date to edit</div>
            <label>Study Hours: <input type="number" id="adminHours" min="0" max="24"></label>
            <label>Notes (HTML allowed): <textarea id="adminNotes" rows="4"></textarea></label>
            <div class="note-preview" id="notePreview"></div>
            <button onclick="saveAdminData()">Save</button>
        </div>

        <div class="results">
            <h3>Analysis for Selected Month</h3>
            <button onclick="viewAnalysis()">Refresh Analysis</button>
            <button onclick="downloadPDF()">Download as PDF</button>
            <div id="analysis-result"></div>
        </div>
    </div>

    <footer class="footer">
        <p>&copy; 2024 Time Analysis Tracker</p>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script>
        // Configuration
        const API_URL = "https://time-tracker.aarif753alam.workers.dev/";
        const encodedPass = "YWE4NzY1NDMyMUA=";
        const ADMIN_PASS = atob(encodedPass);
        
        let currentDate = new Date();
        let isAdmin = false;
        let selectedDateKey = null;

        // Initialize
        document.getElementById('adminToggle').addEventListener('click', toggleAdmin);
        document.getElementById('adminNotes').addEventListener('input', updateNotePreview);
        renderCalendar();
        loadAnalysis();

        // Calendar Functions
        async function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            document.getElementById('monthYear').textContent = 
                `${currentDate.toLocaleString('default', { month: 'long' })} ${year}`;
            
            let calendarHTML = '';
            for (let day = 1; day <= daysInMonth; day++) {
                const dateKey = `${year}-${month + 1}-${day}`;
                calendarHTML += `<div class="day" data-date="${dateKey}">${day}</div>`;
            }
            
            document.getElementById('calendar').innerHTML = calendarHTML;
            
            // Add click handlers
            document.querySelectorAll('.day').forEach(day => {
                day.addEventListener('click', () => selectDate(day.dataset.date));
            });
            
            // Load colors
            await colorizeCalendar();
        }

        async function colorizeCalendar() {
            try {
                const response = await fetch(`${API_URL}/get-month?year=${currentDate.getFullYear()}&month=${currentDate.getMonth() + 1}`);
                const data = await response.json();
                
                document.querySelectorAll('.day').forEach(day => {
                    const dateKey = day.dataset.date;
                    if (data[dateKey]) {
                        const hours = data[dateKey].hours || 0;
                        day.classList.remove('red', 'cyan', 'green');
                        
                        if (hours <= 5) day.classList.add('red');
                        else if (hours <= 7) day.classList.add('cyan');
                        else day.classList.add('green');
                    }
                });
            } catch (error) {
                console.error("Error loading calendar data:", error);
            }
        }

        function changeMonth(offset) {
            currentDate.setMonth(currentDate.getMonth() + offset);
            renderCalendar();
            loadAnalysis();
        }

        // Date Selection
        async function selectDate(dateKey) {
            selectedDateKey = dateKey;
            
            try {
                const response = await fetch(`${API_URL}/get?date=${dateKey}`);
                const data = await response.json();
                
                if (isAdmin) {
                    document.getElementById('selectedDateInfo').innerHTML = `Editing: <strong>${dateKey}</strong>`;
                    document.getElementById('adminHours').value = data?.hours || '';
                    document.getElementById('adminNotes').value = data?.notes || '';
                    updateNotePreview();
                } else {
                    const hours = data?.hours || 'Not recorded';
                    const notes = data?.notes ? `<div class="note-preview">${data.notes}</div>` : 'No notes';
                    alert(`Date: ${dateKey}\nHours: ${hours}\nNotes:\n${notes.replace(/<[^>]*>/g, '')}`);
                }
            } catch (error) {
                console.error("Error loading date data:", error);
            }
        }

        function updateNotePreview() {
            document.getElementById('notePreview').innerHTML = 
                document.getElementById('adminNotes').value || '<em>Preview will appear here</em>';
        }

        // Admin Functions
        function toggleAdmin() {
            if (!isAdmin) {
                const password = prompt("Enter admin password:");
                if (password === ADMIN_PASS) {
                    isAdmin = true;
                    document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
                    document.getElementById('adminToggle').textContent = 'Exit Admin';
                }
            } else {
                isAdmin = false;
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
                document.getElementById('adminToggle').textContent = 'Admin';
            }
        }

        async function saveAdminData() {
            if (!selectedDateKey) {
                alert("Please select a date first");
                return;
            }
            
            const data = {
                hours: document.getElementById('adminHours').value,
                notes: document.getElementById('adminNotes').value
            };
            
            try {
                await fetch(`${API_URL}/save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date: selectedDateKey, ...data })
                });
                
                alert('Saved successfully!');
                await colorizeCalendar();
                loadAnalysis();
            } catch (error) {
                console.error("Error saving data:", error);
                alert("Error saving data");
            }
        }

        // Analysis Functions
        async function loadAnalysis() {
            try {
                const response = await fetch(`${API_URL}/get-month?year=${currentDate.getFullYear()}&month=${currentDate.getMonth() + 1}`);
                const data = await response.json();
                
                let analysisHTML = '<table border="1" style="width:100%;border-collapse:collapse;">';
                analysisHTML += '<tr><th>Date</th><th>Hours</th><th>Notes</th></tr>';
                
                Object.entries(data).forEach(([date, entry]) => {
                    analysisHTML += `
                        <tr>
                            <td>${date}</td>
                            <td>${entry.hours || 0}</td>
                            <td>${entry.notes ? `<div class="note-preview">${entry.notes}</div>` : ''}</td>
                        </tr>
                    `;
                });
                
                analysisHTML += '</table>';
                document.getElementById('analysis-result').innerHTML = analysisHTML;
            } catch (error) {
                console.error("Error loading analysis:", error);
                document.getElementById('analysis-result').innerHTML = '<p>Error loading data</p>';
            }
        }

        async function downloadPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.text("Time Analysis Tracker", 10, 10);
                doc.text(`Study Hours Report for ${document.getElementById('monthYear').textContent}`, 10, 20);
                
                const response = await fetch(`${API_URL}/get-month?year=${currentDate.getFullYear()}&month=${currentDate.getMonth() + 1}`);
                const data = await response.json();
                
                let yOffset = 30;
                Object.entries(data).forEach(([date, entry]) => {
                    doc.text(`${date}: ${entry.hours || 0} hours`, 10, yOffset);
                    yOffset += 7;
                    
                    if (entry.notes) {
                        // Strip HTML tags for PDF
                        const plainNotes = entry.notes.replace(/<[^>]*>/g, '');
                        const splitNotes = doc.splitTextToSize(plainNotes, 180);
                        doc.text(splitNotes, 10, yOffset);
                        yOffset += splitNotes.length * 7;
                    }
                    
                    yOffset += 7;
                    if (yOffset > 280) {
                        doc.addPage();
                        yOffset = 10;
                    }
                });
                
                doc.save("study_analysis.pdf");
            } catch (error) {
                console.error("Error generating PDF:", error);
                alert("Error generating PDF");
            }
        }
    </script>
</body>
</html>
